#compdef railpack

function _railpack {
  local -a args
  local context state line

  args=(
    '--verbose[Enable verbose logging]'
    '(-h --help)'{-h,--help}'[show help]'
    '(-v --version)'{-v,--version}'[print the version]'
  )

  _arguments -C -S \
    "${args[@]}" \
    '1: :_railpack_commands' \
    '*:: :->args'

  case $state in
    (args)
      case $line[1] in
        (build|b)
          _railpack_build
          ;;
        (prepare|p)
          # 'p' is listed as alias for both prepare and plan in help, checking context or defaulting to prepare
          _railpack_prepare
          ;;
        (info|i)
          _railpack_info
          ;;
        (plan)
          _railpack_plan
          ;;
        (schema)
          _railpack_schema
          ;;
        (frontend)
          _railpack_frontend
          ;;
        (help|h)
          _railpack_help
          ;;
        (*)
          # If 'p' is ambiguous and the user typed 'plan', we handle it.
          # If the user typed 'p', we defaulted to prepare above, but let's check if we can distinguish.
          # We can't easily without more info, so standard fallback.
          ;;
      esac
      ;;
  esac
}

function _railpack_commands {
  local -a commands
  commands=(
    "build:build an image with BuildKit"
    "b:alias for build"
    "prepare:prepares all the files necessary for a platform"
    "info:get as much information as possible about an app"
    "i:alias for info"
    "plan:generate a build plan for a directory"
    "p:alias for prepare or plan"
    "schema:outputs the JSON schema for the Railpack config"
    "frontend:Start the BuildKit GRPC frontend server"
    "help:Shows a list of commands or help for one command"
    "h:alias for help"
  )
  _describe -t commands 'railpack command' commands
}

function _railpack_build {
  _arguments -S \
    '--name=[name of the image to build]:image name' \
    '--output=[output the final filesystem to a local directory]:directory:_files -/' \
    '--platform=[platform to build for (e.g. linux/amd64, linux/arm64)]:platform' \
    '--progress=[buildkit progress output mode]:mode:(auto plain tty)' \
    '--show-plan[Show the build plan before building]' \
    '--cache-key=[Unique id to prefix to cache keys]:key' \
    '*'{-e,--env}'=[environment variables to set]:env variable' \
    '*--previous=[versions of packages used for previous builds]:previous package' \
    '--build-cmd=[build command to use]:command' \
    '--start-cmd=[start command to use]:command' \
    '--config-file=[relative path to railpack config file]:config file:_files' \
    '--error-missing-start[error if no start command is found]' \
    '(-h --help)'{-h,--help}'[show help]' \
    '1:directory:_files -/'
}

function _railpack_prepare {
  _arguments -S \
    '--plan-out=[output file for the JSON serialized build plan]:file:_files' \
    '--info-out=[output file for the JSON serialized build result info]:file:_files' \
    '--show-plan[dump the build plan to stdout]' \
    '--hide-pretty-plan[hide the pretty-printed build result output]' \
    '*'{-e,--env}'=[environment variables to set]:env variable' \
    '*--previous=[versions of packages used for previous builds]:previous package' \
    '--build-cmd=[build command to use]:command' \
    '--start-cmd=[start command to use]:command' \
    '--config-file=[relative path to railpack config file]:config file:_files' \
    '--error-missing-start[error if no start command is found]' \
    '(-h --help)'{-h,--help}'[show help]' \
    '1:directory:_files -/'
}

function _railpack_info {
  _arguments -S \
    '--format=[output format]:format:(pretty json)' \
    '--out=[output file name]:file:_files' \
    '*'{-e,--env}'=[environment variables to set]:env variable' \
    '*--previous=[versions of packages used for previous builds]:previous package' \
    '--build-cmd=[build command to use]:command' \
    '--start-cmd=[start command to use]:command' \
    '--config-file=[relative path to railpack config file]:config file:_files' \
    '--error-missing-start[error if no start command is found]' \
    '(-h --help)'{-h,--help}'[show help]' \
    '1:directory:_files -/'
}

function _railpack_plan {
  _arguments -S \
    '(-o --out)'{-o,--out}'=[output file name]:file:_files' \
    '*'{-e,--env}'=[environment variables to set]:env variable' \
    '*--previous=[versions of packages used for previous builds]:previous package' \
    '--build-cmd=[build command to use]:command' \
    '--start-cmd=[start command to use]:command' \
    '--config-file=[relative path to railpack config file]:config file:_files' \
    '--error-missing-start[error if no start command is found]' \
    '(-h --help)'{-h,--help}'[show help]' \
    '1:directory:_files -/'
}

function _railpack_schema {
  _arguments -S \
    '(-h --help)'{-h,--help}'[show help]'
}

function _railpack_frontend {
  _arguments -S \
    '--verbose[Enable verbose logging]' \
    '(-h --help)'{-h,--help}'[show help]' \
    '*:: :->args'
}

function _railpack_help {
  _arguments -S \
    '1: :_railpack_commands'
}

_railpack "$@"
